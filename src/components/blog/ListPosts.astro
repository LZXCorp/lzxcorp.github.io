---
import BlogPost from "./BlogPost.astro";
import Heading from "../ui/Heading.astro";
import { Icon } from "astro-icon/components";

export interface Props {
  excludeLatest?: boolean;
  currentPostUrl?: string;
  all?: boolean;
}

const { excludeLatest = false, currentPostUrl = "", all = false } = Astro.props;

const postModules = import.meta.glob("../../pages/blog/posts/*.md", { eager: true });
const allPosts = Object.values(postModules) as any[];
allPosts.sort((a, b) => {
  const dateA = new Date(a.frontmatter.pubDate).getTime();
  const dateB = new Date(b.frontmatter.pubDate).getTime();
  return dateB - dateA;
});

let postsToShow = allPosts;

if (currentPostUrl) {
  postsToShow = postsToShow.filter((post) => {
    if (!post.url) return false;
    const normalizedPostUrl = post.url.replace(/\/$/, "");
    const normalizedCurrentUrl = currentPostUrl.replace(/\/$/, "");
    return normalizedPostUrl !== normalizedCurrentUrl;
  });
} else if (excludeLatest) {
  postsToShow = postsToShow.slice(1);
}

if (!all) {
  postsToShow = postsToShow.slice(0, 4);
}
---

<section
  class="py-8 max-lg:px-4 max-md:px-8 max-sm:px-0 max-md:py-4 max-w-4xl mx-auto"
>
  {
    all && (
      <div class="flex gap-4 pb-6 items-center text-center justify-center">
        <Icon name="scan" class="size-5 text-mint-500" />
        <Heading text="All" textGradient="Posts" level={2} />
      </div>
    )
  }

  <div class="flex flex-col gap-8 w-full mx-auto">
    {
      postsToShow.map((post) => (
        <BlogPost
          url={post.url}
          title={post.frontmatter.title}
          date={post.frontmatter.pubDate}
          tags={post.frontmatter.tags}
          languages={post.frontmatter.languages}
          image={post.frontmatter.image}
        />
      ))
    }
  </div>
  {
    !all && (
      <div id="morePosts" class="w-full flex justify-center text-center my-12">
        <a
          href="/blog/posts/"
          class="group inline-flex items-center gap-2 font-bold cursor-pointer text-mint-400 dark:text-mint-100 hover:text-mint-500 dark:hover:text-mint-300 transition-all"
        >
          <Icon name="terminal" class="size-3.5 text-mint-500/50 group-hover:text-mint-500 transition-colors" />
          <span>View all posts</span>
          <Icon name="arrow-left" class="size-3.5 rotate-180 group-hover:translate-x-1 transition-transform duration-300" />
        </a>
      </div>
    )
  }
</section>
